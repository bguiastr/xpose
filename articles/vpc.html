<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visual Predictive Checks (VPC) • xpose</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Visual Predictive Checks (VPC)">
<meta property="og:description" content="xpose">
<meta property="og:image" content="https://uupharmacometrics.github.io/xpose/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">xpose</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.18</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    </li>
<li class="dropdown-header">Getting started</li>
    <li>
      <a href="../reference/figures/cheatsheet.pdf">Cheat sheet (pdf)</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/import_model_outputs.html">Import model outputs</a>
    </li>
    <li>
      <a href="../articles/access_xpdb_data.html">Access xpdb data</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Going further</li>
    <li>
      <a href="../articles/customize_plots.html">Customize plots</a>
    </li>
    <li>
      <a href="../articles/multiple_pages.html">Multiple pages</a>
    </li>
    <li>
      <a href="../articles/vpc.html">Visual Predictive Checks (VPC)</a>
    </li>
    <li>
      <a href="../articles/interactive_plots.html">Create interactive plots (beta)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../articles/plot_list.html">Plots</a>
</li>
<li>
  <a href="../articles/faq.html">FAQ</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/about.html">About</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://github.com/UUPharmacometrics/xpose" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/UUPharmacometrics/xpose/releases" class="external-link">
    <span class="fa fa-download"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Visual Predictive Checks (VPC)</h1>
                        <h4 data-toc-skip class="author">Benjamin
Guiastrennec</h4>
            
            <h4 data-toc-skip class="date">12 February, 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/UUPharmacometrics/xpose/blob/HEAD/vignettes/vpc.Rmd" class="external-link"><code>vignettes/vpc.Rmd</code></a></small>
      <div class="hidden name"><code>vpc.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="disclosure">Disclosure<a class="anchor" aria-label="anchor" href="#disclosure"></a>
</h3>
<p>The Visual predictive checks (VPC) shown below are only intended to
demonstrate the various options available in xpose and should not be
used as reference for modeling practice. Furthermore, the plots are only
based on 20 simulations to minimize the computing time of the examples,
the size of the <code>xpdb_ex_pk</code> object and of the xpose package
in general.</p>
</div>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>VPC can be created either by:</p>
<ol style="list-style-type: decimal">
<li>Using an xpdb containing a simulation and an estimation problem</li>
<li>Using a <a href="https://uupharmacometrics.github.io/PsN/" class="external-link">PsN</a>
generated VPC folder</li>
</ol>
<p>The VPC functionality in xpose is build around the <a href="https://cran.r-project.org/package=vpc" class="external-link">vpc R package</a>. For
more details about the way the vpc package works, please check the <a href="https://github.com/ronkeizer/vpc" class="external-link">github repository</a>.</p>
</div>
<div class="section level3">
<h3 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h3>
<p>The VPC computing and plotting parts have been separated into two
distinct functions: <code><a href="../reference/vpc_data.html">vpc_data()</a></code> and <code><a href="../reference/vpc.html">vpc()</a></code>
respectively. This allows to:</p>
<ul>
<li>Optimize the speed when adjusting the graphics aesthetics</li>
<li>Adjust the VPC data (e.g. remove panels or factor labels) before
plotting</li>
<li>Facilitate error debugging</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xpdb_ex_pk</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc_data.html">vpc_data</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># Compute the vpc data</span></span>
<span> <span class="fu"><a href="../reference/vpc.html">vpc</a></span><span class="op">(</span><span class="op">)</span>            <span class="co"># Plot the vpc</span></span></code></pre></div>
<p><img src="vpc_files/figure-html/unnamed-chunk-2-1.png" width="75%" style="display: block; margin: auto;"></p>
<p>The generated VPC data is stored in the xpdb under specials datasets
and can be used later on.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xpdb_w_vpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vpc_data.html">vpc_data</a></span><span class="op">(</span><span class="va">xpdb_ex_pk</span><span class="op">)</span> <span class="co"># Compute and store VPC data</span></span>
<span></span>
<span><span class="va">xpdb_w_vpc</span> <span class="co"># The vpc data is now listed under the xpdb "special" data</span></span></code></pre></div>
<pre><code>run001.lst overview: 
 - Software: nonmem 7.3.0 
 - Attached files (memory usage 1.5 Mb): 
   + obs tabs: $prob no.1: catab001.csv, cotab001, patab001, sdtab001 
   + sim tabs: $prob no.2: simtab001.zip 
   + output files: run001.cor, run001.cov, run001.ext, run001.grd, run001.phi, run001.shk 
   + special: vpc continuous (#3) 
 - gg_theme: theme_readable 
 - xp_theme: theme_xp_default 
 - Options: dir = data, quiet = FALSE, manual_import = NULL</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vpc.html">vpc</a></span><span class="op">(</span><span class="va">xpdb_w_vpc</span><span class="op">)</span> <span class="co"># Plot the vpc from the stored data</span></span></code></pre></div>
<p><img src="vpc_files/figure-html/unnamed-chunk-3-1.png" width="75%" style="display: block; margin: auto;"></p>
<p>Multiple VPC data can be stored in an xpdb, but only one of each
<code>vpc_type</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xpdb_w_multi_vpc</span> <span class="op">&lt;-</span> <span class="va">xpdb_ex_pk</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc_data.html">vpc_data</a></span><span class="op">(</span>vpc_type <span class="op">=</span> <span class="st">'continuous'</span>, opt <span class="op">=</span> <span class="fu"><a href="../reference/vpc_opt.html">vpc_opt</a></span><span class="op">(</span>n_bins <span class="op">=</span> <span class="fl">6</span>, lloq <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc_data.html">vpc_data</a></span><span class="op">(</span>vpc_type <span class="op">=</span> <span class="st">'censored'</span>, opt <span class="op">=</span> <span class="fu"><a href="../reference/vpc_opt.html">vpc_opt</a></span><span class="op">(</span>n_bins <span class="op">=</span> <span class="fl">6</span>, lloq <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vpc.html">vpc</a></span><span class="op">(</span><span class="va">xpdb_w_multi_vpc</span>, vpc_type <span class="op">=</span> <span class="st">'continuous'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/vpc.html">vpc</a></span><span class="op">(</span><span class="va">xpdb_w_multi_vpc</span>, vpc_type <span class="op">=</span> <span class="st">'censored'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="common-options">Common options<a class="anchor" aria-label="anchor" href="#common-options"></a>
</h3>
<div class="section level4">
<h4 id="options-in-vpc_data">Options in <code>vpc_data()</code><a class="anchor" aria-label="anchor" href="#options-in-vpc_data"></a>
</h4>
<ul>
<li>The option <code>vpc_type</code> allows to specify the type of VPC
to be computed: “continuous” (default), “categorical”, “censored”,
“time-to-event”.</li>
<li>The <code>stratify</code> options defines up to two stratifying
variable to be used when computing the VPC data. The
<code>stratify</code> variables can either be provided as a character
vector (<code>stratify = c('SEX', 'MED1')</code>) or a formula
(<code>stratify = SEX~MED1</code>) . The former will result in the use
of <code><a href="https://ggforce.data-imaginist.com/reference/facet_wrap_paginate.html" class="external-link">ggforce::facet_wrap_paginate()</a></code> and the latter of
<code><a href="https://ggforce.data-imaginist.com/reference/facet_grid_paginate.html" class="external-link">ggforce::facet_grid_paginate()</a></code> when creating the plot. With
“categorical” VPC the “group” variable will also be added by
default.</li>
<li>More advanced options (i.e. binning, pi, ci, predcorr, lloq, etc.)
are accessible via the <code>opt</code> argument. The <code>opt</code>
argument expects the output from the <code><a href="../reference/vpc_opt.html">vpc_opt()</a></code> functions
argument.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xpdb_ex_pk</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc_data.html">vpc_data</a></span><span class="op">(</span>vpc_type <span class="op">=</span> <span class="st">'censored'</span>, stratify <span class="op">=</span> <span class="st">'SEX'</span>,</span>
<span>          opt <span class="op">=</span> <span class="fu"><a href="../reference/vpc_opt.html">vpc_opt</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="st">'jenks'</span>, n_bins <span class="op">=</span> <span class="fl">7</span>, lloq <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc.html">vpc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="options-in-vpc">Options in <code>vpc()</code><a class="anchor" aria-label="anchor" href="#options-in-vpc"></a>
</h4>
<ul>
<li>The option <code>vpc_type</code> works similarly to
<code><a href="../reference/vpc_data.html">vpc_data()</a></code> and is only required if several VPC data are
associated with the xpdb.</li>
<li>The option <code>smooth = TRUE/FALSE</code> allows to switch between
smooth and squared shaded areas.</li>
<li>The plot VPC function works similarly to all other xpose functions
to map and customize aesthetics. However in this case the
<code>area_fill</code> and <code>line_linetype</code> each require three
values for the low, median and high percentiles respectively.</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="creating-vpc-using-the-xpdb-data">Creating VPC using the xpdb data<a class="anchor" aria-label="anchor" href="#creating-vpc-using-the-xpdb-data"></a>
</h3>
<p>To create VPC using the xpdb data, at least one simulation and one
estimation problem need to present. Hence in the case of NONMEM the run
used to generate the xpdb should contain several<code>$PROBLEM</code>.
In <code><a href="../reference/vpc_data.html">vpc_data()</a></code> the problem number can be specified for the
observation (<code>obs_problem</code>) and the simulation
(<code>sim_problem</code>). By default xpose picks the last one of each
to generate the VPC.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View the xpdb content and data problems</span></span>
<span><span class="va">xpdb_ex_pk</span></span></code></pre></div>
<pre><code>run001.lst overview: 
 - Software: nonmem 7.3.0 
 - Attached files (memory usage 1.5 Mb): 
   + obs tabs: $prob no.1: catab001.csv, cotab001, patab001, sdtab001 
   + sim tabs: $prob no.2: simtab001.zip 
   + output files: run001.cor, run001.cov, run001.ext, run001.grd, run001.phi, run001.shk 
   + special: &lt;none&gt; 
 - gg_theme: theme_readable 
 - xp_theme: theme_xp_default 
 - Options: dir = data, quiet = FALSE, manual_import = NULL</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate the vpc</span></span>
<span><span class="va">xpdb_ex_pk</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc_data.html">vpc_data</a></span><span class="op">(</span>vpc_type <span class="op">=</span> <span class="st">'continuous'</span>, obs_problem <span class="op">=</span> <span class="fl">1</span>, sim_problem <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc.html">vpc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="vpc_files/figure-html/unnamed-chunk-6-1.png" width="75%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="creating-the-vpc-using-a-psn-folder">Creating the VPC using a PsN folder<a class="anchor" aria-label="anchor" href="#creating-the-vpc-using-a-psn-folder"></a>
</h3>
<p>The <code><a href="../reference/vpc_data.html">vpc_data()</a></code> contains an argument
<code>psn_folder</code> which can be used to point to a <a href="https://uupharmacometrics.github.io/PsN/" class="external-link">PsN</a> generated VPC
folder. As in most xpose function <code>template_titles</code> keywords
can be used to automatize the process
e.g. <code>psn_folder = '@dir/@run_vpc'</code> where <code>@dir</code>
and <code>@run</code> will be automatically translated to initial
(i.e. when the xpdb was generated) run directory and run number
<code>'analysis/models/pk/run001_vpc'</code>.</p>
<p>In this case, the data will be read from the <code>/m1</code>
sub-folder (or <code>m1.zip</code> if compressed). Note that <a href="https://uupharmacometrics.github.io/PsN/" class="external-link">PsN</a> drops unused
columns to reduce the simtab file size. Thus, in order to allow for more
flexibility in R, it is recommended to use multiple stratifying
variables (<code>-stratify_on=VAR1,VAR2</code>) and the prediction
corrected (<code>-predcorr</code> adds the PRED column to the output)
options in <a href="https://uupharmacometrics.github.io/PsN/" class="external-link">PsN</a> to
avoid having to rerun <a href="https://uupharmacometrics.github.io/PsN/" class="external-link">PsN</a> to add these
variables later on. In addition, <code>-dv</code>, <code>-idv</code>,
<code>-lloq</code>, <code>-uloq</code>, <code>-predcorr</code> and
<code>-stratify_on</code> <a href="https://uupharmacometrics.github.io/PsN/" class="external-link">PsN</a> options are
automatically applied to xpose VPC.</p>
<p>The PsN generated binning can also applied to xpose VPC with the
<code><a href="../reference/vpc_data.html">vpc_data()</a></code> option <code>psn_bins = TRUE</code> (disabled by
default). However <a href="https://uupharmacometrics.github.io/PsN/" class="external-link">PsN</a> and the vpc
package work slightly differently so the results may not be optimal and
the output should be evaluated carefully.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xpdb_ex_pk</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc_data.html">vpc_data</a></span><span class="op">(</span>psn_folder <span class="op">=</span> <span class="st">'@dir/run001_vpc'</span>, psn_bins <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="../reference/vpc.html">vpc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://github.com/guiastrennec" class="external-link">Benjamin Guiastrennec</a>, <a href="https://github.com/andrewhooker" class="external-link">Andrew C. Hooker</a>, <a href="https://github.com/sebastianueckert" class="external-link">Sebastian Ueckert</a>, <a href="https://katalog.uu.se/profile/?id=XX3384" class="external-link">Mats O. Karlsson</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
